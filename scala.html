<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="referrer" content="no-referrer">
  <link rel="shortcut icon" type="image/x-icon" href="plutus.svg" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <title>Scala</title>
  <style>

    *
    {
        box-sizing: border-box;
    }

    body
    {
        font-family: sans-serif;
        background: black;
        margin: 0;
        padding: 0;
        color: whitesmoke;
    }

    .container
    {
        margin: 0 auto;
        max-width: 800px;
    }

    </style>
  </head>
  <body>
    <div class="container">
      <div id="deck"></div>
    </div>
    <script>

    // --- security function

    function encrypt(text, passphrase) { return CryptoJS.AES.encrypt(text, passphrase).toString() }
    function decrypt(text, passphrase) { return CryptoJS.AES.decrypt(text, passphrase).toString(CryptoJS.enc.Utf8) }

    // --- constants

    const PARM = new URLSearchParams(window.location.search);
    const HTML = decrypt('U2FsdGVkX1+Xgmkh/13HfADWyL4/PfpbDoE+jCnDGUuePJH/1WGy0ktGRKeXOV+SnTJ+0AEu5bnDXHkbA+U1i7LYJQL3pzhu9rSz7z9djRjPBTyj5VdTWALxAckNTLRm', PARM.get('k') || ''); // see lambda/html-source
    const DECK = document.getElementById('deck');
    const VIDS = /["']([^"']+\.mp4)["']/g;

    // --- grab a site page

    function grab(url) {
        return fetch(HTML + encodeURIComponent(url))
        .then(res => res.json())
        .then(out => out.text)
        .then(txt => {
            let div = document.createElement('div');
            div.innerHTML = txt;
            return div;
        });
    }

    // --- check if a url is relative

    function relative(url) {
        return url.startsWith('http') === false;
    }

    // --- make a url absolute if not already

    function absolute(url, origin) {
        return relative(url) ? origin + url : url;
    }

    // --- browse the url

    function browse(url) {
        let parts = new URL(url);

        grab(url).then(doc => {
            let text = [];

            while((match = VIDS.exec(doc.innerHTML)) !== null) {
                text.push(`<a href="${ match[1] }" target="new">${ match[1] }</a>`);
            }

            doc.querySelectorAll('a').forEach(i => {
                let path = i.getAttribute('href');
                let img  = i.querySelector('img');
                let txt  = i.textContent || '';

                if (path) {
                    let href = absolute(path, parts.origin);
                    let link = `<a href="#" onclick="browse('${ href }')">[TEXT]</a><br/>${ href }`;

                    if (img) {
                        let src = absolute(img.getAttribute('thumb') || img.getAttribute('src'), parts.origin);
                        text.push(link.replace('[TEXT]', `<img src="${ src }" /><br/>${ txt }`));
                    }
                    else {
                        text.push(link.replace('[TEXT]', `${ txt }`));
                    }

                    text.push('<hr/>');
                }
            });

            DECK.innerHTML = text.join('<br/>');
        });
    }

    // --- entry point

    browse(PARM.get('url') || '');

    // --- unload protection

    // window.onbeforeunload = (() => true)

    </script>
  </body>
</html>
